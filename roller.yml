#
version: "0.0.1"
# Флаг атомарности
# В данном случае, распространяется на весь манифест
# Если что-либо завершено неуспешно в этом манифесте, 
# то весь манифест будет откатан до первоначалього состояния
atomic: true
# Главная и начальная структура
stage:
# Уникальное имя этапа
# На него можно будет ссылаться при указании зависимостей
# Не должен содержать пробелы или кирилицу 
- name: MDM 
  # Подробное описание действия
  # В данном случае, описание этапа
  desc: "Установка группы мдм" 
  # Флаг атомарности
  # В данном случае, распространяется на весь этап
  # Если что-либо завершено неуспешно в этом этапе, 
  # то весь этап будет откатан до первоначалього состояния
  atomic: true
  
    
  pre_check: 
    # Если в чеке используется сторонний плагин, 
    # то его нужно указать явно с помощью 'plugin:' и его названия
    plugin: 'ssh_plugin'
    #
    #
    location: # Описаниен местодействия
      host: "127.0.0.1"
      port: 22
      user: "admin"
      password: "1604"
    #
    #
    action:
      run: "ls -asl /etc"

  rollback: false
  
  # Начало описания шагов
  step:  
  - name: adapter # Уникальное имя шага
    location: # Описаниен местодействия
        
    desc: "Установка мдм-адаптера" # Описание этапа 
    helm:
      actions: upgrade
      helm_dir: /data
      release_name: mdm-adapter
      version: 1.9.2
    atomic: true # Флаг атомарности обновления
    pre_check: 
      plugin: "k8s_plugin"
      location: # Описание локации
        kubeconfig: "/path/to/kubeconfig"  # Путь к файлу kubeconfig для подключения к Kubernetes
        namespace: "default"  # Указываем namespace, в котором будет выполняться команда
      action:
        kubernetes:
          run: "kubectl apply -f /path/to/deployment.yaml"
    post_check: 
      bash:
        run: "cd /etc"
    rollback: false

  - name: repaptitioner
    dependence: 
      finish: MDM.adapter # Зависимость от завершения шага adapter в этапе MDM
    yum:
      actions: install
      packet_name: mdm-adapter
      version: 1.9.2
      atomic: true

- name: Assembler # Уникальное имя этапа
  desc: "Установка группы сборщика" # Описание этапа 
  step: # Начало описания шага 
  - name: party # Уникальное имя шага
    desc: "Установка мдм-адаптера" # Описание этапа 
    helm:
      actions: upgrade
      helm_dir: /data
      release_name: mdm-adapter
      version: 1.9.2
    atomic: true # Флаг атомарности обновления
    rollback: false

  - name: repaptitioner
    dependence: 
      finish: MDM.adapter # Зависимость от завершения шага adapter в этапе MDM
    yum:
      actions: install
      packet_name: mdm-adapter
      version: 1.9.2
      atomic: true