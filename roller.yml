#
version: "0.0.1"
# Главная и начальная структура
stage:
# Уникальное имя этапа
# На него можно будет ссылаться при указании зависимостей
# Не должен содержать пробелы или кирилицу 
- name: MDM 
  # Подробное описание действия
  # В данном случае, описание этапа
  desc: "Установка группы мдм" 
  # Флаг атомарности
  # В данном случае, распространяется на весь этап
  # Если что-либо завершено неуспешно в этом этапе, 
  # то весь этап будет откатан до первоначалього состояния
  atomic: true
  
    
  pre_check: 
    # Если в чеке используется сторонний плагин, 
    # то его нужно указать явно с помощью 'plugin:' и его названия
    plugin: 'ssh_plugin'
    #
    #
    location: # Описаниен местодействия
      host:
      port:
      user:
      password:
    #
    #
    action:
      bash:
        run: "cd /etc"

  rollback: false
  
  # Начало описания шагов
  step:  
  - name: adapter # Уникальное имя шага
    location: # Описаниен местодействия
      plugin_type: "ssh_plugin"
      KubeConfig: 
        namespace: "Название"
        # Если хост
      host:
        user:
        address:
        port:
        
    desc: "Установка мдм-адаптера" # Описание этапа 
    helm:
      actions: upgrade
      helm_dir: /data
      release_name: mdm-adapter
      version: 1.9.2
    atomic: true # Флаг атомарности обновления
    pre_check: 
      location:
        KubeConfig: 
          namespace: "Название"
        host:
          user: "admin"
          address: "192.168.1.12"
          port:
          password: 1604
          bash:
            script: "/mnt/c/Users/admin/script.bat"
    post_check: 
      bash:
        run: "cd /etc"
    rollback: false

  - name: repaptitioner
    dependence: 
      finish: MDM.adapter # Зависимость от завершения шага adapter в этапе MDM
    yum:
      actions: install
      packet_name: mdm-adapter
      version: 1.9.2
      atomic: true

- name: Assembler # Уникальное имя этапа
  desc: "Установка группы сборщика" # Описание этапа 
  step: # Начало описания шага 
  - name: party # Уникальное имя шага
    desc: "Установка мдм-адаптера" # Описание этапа 
    helm:
      actions: upgrade
      helm_dir: /data
      release_name: mdm-adapter
      version: 1.9.2
    atomic: true # Флаг атомарности обновления
    rollback: false

  - name: repaptitioner
    dependence: 
      finish: MDM.adapter # Зависимость от завершения шага adapter в этапе MDM
    yum:
      actions: install
      packet_name: mdm-adapter
      version: 1.9.2
      atomic: true